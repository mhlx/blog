<!doctype html>
<html>
<head th:replace="console/fragment/head('文章管理')"></head>
<body style="height: 100% !important;">
	<div class="page">
		<div class="flex-fill">
			<div th:replace="console/fragment/profile"></div>
			<div th:replace="console/fragment/headermenu('article')"></div>
			<div class="my-3 my-md-5">
				<div class="container">
					<form th:action="@{/console/articles}">
						<div class="page-header">
							<div class="page-options d-flex">

								<a class="btn btn-primary"
									onclick="$('#statModal').modal('show')"
									style="margin-left: 20px"> <i class="fas fa-chart-bar"
									style="color: #fff"></i>
								</a> <a class="btn btn-primary"
									onclick="$('#queryModal').modal('show')"
									href="javascript:void(0)" style="margin-left: 20px"> <i
									class="fas fa-search"></i>
								</a> <a class="btn btn-primary" th:href="@{/console/article/write}"
									style="margin-left: 20px"> <i class="far fa-plus-square"></i>
								</a>
							</div>
						</div>

						<div class="row row-cards row-deck">
							<div class="col-xl-6" th:each="article : ${page.datas}">
								<div class="card card-aside" th:data-articleid="${article.id}">
									<div th:if="${article.featureImage != null}" th:remove="tag">
										<a href="javascript:void(0)" class="card-aside-column"
											th:style="'background-image: url('+@{${article.featureImage}}+')'"></a>
									</div>

									<div class="card-body d-flex flex-column">
										<h4>
											<a href="javascript:void(0)">[[${article.title}]]</a>
										</h4>
										<div class="text-muted mb-1">
											<small> <a href="javascript:void(0)"
												th:onclick="'queryCategory(\''+${category.name}+'\')'"
												class="badge badge-primary mr-1"
												th:each="category : ${article.categories}">[[${category.name}]]</a>
											</small>
										</div>
										<div class="text-muted mb-1" th:if="${article.tags != null}">
											<small> <a href="javascript:void(0)"
												th:onclick="'queryTag(\''+${tag.name}+'\')'"
												class="badge  mr-1" style="color: inherit"
												th:each="tag : ${article.tags}">[[${tag.name}]]</a>
											</small>
										</div>
										<div class="text-muted mb-1"
											th:if="${article.summary != null}"
											th:with="parser=${#jsoups.parser(#jsoups.body(article.summary))}">
											[[${parser.text}]]</div>
										<div class="text-muted">
											<small> <span class="badge  mr-1"
												style="color: inherit"><i class="far fa-comment mr-1"></i>[[${article.comments}]]<i
													class="fas fa-fire mr-1 ml-2"></i>[[${article.hits}]]</span>
											</small>
										</div>
										<div class="d-flex align-items-center pt-5 mt-auto">
											<div>
												<small class="d-block text-muted mr-1"
													th:text="${#times.format(article.pubDate,'yyyy-MM-dd HH:mm:ss')}"
													th:if="${article.pubDate != null}"></small>
											</div>
											<div>
												<a href="javascript:void(0)" th:data-trash="${article.id}"><i
													class="fe fe-delete mr-1"></i></a> <a
													th:href="@{/console/articles/}+${article.id}+'/edit'"><i
													class="fe fe-edit mr-1"></i></a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<ul class="pagination pagination-simple  justify-content-center"
							th:if="${page.hasPaging}"
							th:with="paging=${#pagings.step(page,5)}">
							<li th:each=" i : ${paging}"
								th:class="${(i == page.currentPage) ? 'page-item active' : 'page-item'}"><a
								class="page-link" th:onclick="'paging(\''+${i}+'\')'"
								href="javascript:void(0)" th:text="${i}"></a></li>
						</ul>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="queryModal" tabindex="-1" role="dialog"
		aria-labelledby="queryModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form th:action="@{/console/articles}" id="queryForm">
						<input type="hidden" id="currentPage"
							th:value="${page.param.currentPage}" name="currentPage">
						<input type="hidden" th:value="${page.param.pageSize}"
							name="pageSize">
						<div class="mb-3">
							<div class="form-label">类别</div>
							<select class="form-control" name="category" id="category">
							</select>
						</div>
						<div class="mb-3">
							<div class="form-label">状态</div>
							<select class="form-control" name="status"
								th:with="status=${page.param.status.name()}">
								<option value="PUBLISHED"
									th:attr="selected=${status == 'PUBLISHED' ? 'selected' : null}">发布</option>
								<option value="DRAFT"
									th:attr="selected=${status == 'DRAFT' ? 'selected' : null}">草稿</option>
								<option value="SCHEDULED"
									th:attr="selected=${status == 'SCHEDULED' ? 'selected' : null}">计划</option>
							</select>
						</div>
						<div class="mb-3">
							<div class="form-label">标签</div>
							<input type="text" class="form-control" id="tag"
								th:value="${page.param.tag}" name="tag">
						</div>
						<div class="mb-3">
							<div class="form-label">内容</div>
							<input type="text" class="form-control"
								th:value="${page.param.query}" name="query">
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary"
						onclick="document.getElementById('currentPage').value='1';document.getElementById('queryForm').submit()">查询</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="articleModal" tabindex="-1" role="dialog"
		aria-hidden="true">
		<div class="modal-dialog  modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"></h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body markdown-body"></div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="statModal" tabindex="-1" role="dialog"
		aria-labelledby="proModal" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">统计</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<h5>明细(仅统计发布状态)</h5>
					<div class="table-responsive">
						<table class="table">
							<tr>
								<th>首次发布日期</th>
								<td><span th:if="${statistic.firstPubDate != null}"
									th:remove="tag">[[${#times.format(statistic.firstPubDate,'yyyy-MM-dd
										HH:mm')}]]</span></td>
							</tr>
							<tr>
								<th>最后发布日期</th>
								<td><span th:if="${statistic.lastPubDate != null}"
									th:remove="tag">[[${#times.format(statistic.lastPubDate,'yyyy-MM-dd
										HH:mm')}]]</span></td>
							</tr>
							<tr>
								<th>最后修改日期</th>
								<td><span th:if="${statistic.lastModifyDate != null}"
									th:remove="tag">[[${#times.format(statistic.lastModifyDate,'yyyy-MM-dd
										HH:mm')}]]</span></td>
							</tr>
							<tr>
								<th>总点击数</th>
								<td>[[${statistic.hits}]]</td>
							</tr>
							<tr>
								<th>总评论数</th>
								<td>[[${statistic.comments}]]</td>
							</tr>
						</table>
					</div>

					<h5>分类统计(仅统计发布状态)</h5>
					<div class="table-responsive">
						<table class="table">
							<tr>
								<th>分类名</th>
								<th>文章数</th>
							</tr>
							<tr th:each="stat : ${statistic.categoryStatistics}">
								<td>[[${stat.category.name}]]</td>
								<td>[[${stat.count}]]</td>
							</tr>
						</table>
					</div>

					<h5>状态统计</h5>
					<div class="table-responsive">
						<table class="table">
							<tr>
								<th>状态</th>
								<th>文章数</th>
							</tr>
							<tr th:each="stat : ${statistic.statusStatistics}">
								<td><span th:if="${stat.status.name() == 'PUBLISHED'}"
									th:remove="tag">发布</span><span
									th:if="${stat.status.name() == 'DRAFT'}" th:remove="tag">草稿</span><span
									th:if="${stat.status.name() == 'SCHEDULED'}" th:remove="tag">计划</span></td>
								<td>[[${stat.count}]]</td>
							</tr>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>

	<footer th:replace="console/fragment/footer"></footer>
	<script>
		document.querySelector('input[name="query"]').addEventListener(
				'keydown', function(e) {
					if (e.key == 'Enter')
						document.querySelector('form').submit();
				})
		function paging(page) {
			document.getElementById('currentPage').value = page;
			document.getElementById('queryForm').submit();
		}
		
		for(const ele of document.querySelectorAll('[data-articleid]')){
			ele.addEventListener('click',function(e){
				var target = e.target;
				while(target != null){
					if(target.hasAttribute('data-trash')
							|| target.classList.contains('icon')){
						return ;
					}
					target = target.parentElement;
				}
				var id = this.dataset.articleid;
				$.ajax({
					type : 'post',
					url : rootPath + 'console/articles/'+id,
					success:function(data) {
						var modal = $('#articleModal');
						modal.find('.modal-title').html(data.title);
						modal.find('.modal-body').html(data.content);
						modal.modal('show');
					}
				  })
			})
		}
		
		
		for(const ele of document.querySelectorAll('[data-trash]')){
			ele.addEventListener('click',function(){
				var id = this.dataset.trash;
				Swal.fire({
					  title: '确定删除吗？',
					  icon: 'warning',
					  showCancelButton: true,
					  confirmButtonColor: '#3085d6',
					  cancelButtonColor: '#d33'
					}).then((result) => {
					  if (result.value) {
						  	$.ajax({
								type : 'post',
								url : rootPath + 'console/articles/'+id+'/delete',
								success:function(data) {
									toast('删除成功');
									setTimeout(function(){
										window.location.reload();
									},800)
								}
							  })
					  }
					})
			});
		}
		
		
		var categoryName = '[[${page.param.category}]]'
		
		$.get(rootPath + 'console/categories',{},function(datas){
			var category = document.getElementById("category");
			var html = '<option value="">全部</option>';
			for(const data of datas){
				html += '<option value="'+data.name+'">'+data.name+'</option>';
			}
			category.innerHTML = html;
			category.value = categoryName;
		});
		
		function queryCategory(category){
			document.getElementById('category').value = category;
			document.getElementById('currentPage').value = '1';
			document.getElementById('queryForm').submit();
		}
		function queryTag(tag){
			document.getElementById('tag').value = tag;
			document.getElementById('currentPage').value = '1';
			document.getElementById('queryForm').submit();
		}
	</script>
</body>
</html>