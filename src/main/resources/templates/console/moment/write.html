<!doctype html>
<html>
<head th:replace="console/fragment/head('动态创建')"></head>
<body class="">
	<div class="page">
		<div class="flex-fill">
			<div th:replace="console/fragment/profile"></div>
			<div th:replace="console/fragment/headermenu('moment')"></div>
			<div class="my-3 my-md-5">
				<div class="container">
					<div class="mb-3" style="text-align:right">
					
						<button type="button" class="btn btn-danger" id="back-btn">返回</button>
						<button type="button" class="btn btn-primary" id="submit-btn">提交</button>
					</div>
					<div class="mb-3">
						<textarea class="form-control" id="editor"></textarea>
						<div class="invalid-feedback" data-invalid-target="content"></div>
					</div>
					<div class="mb-3">
						<label class="form-label">时间</label> <input type="text" id="time"
							class="form-control"
							th:value="${#temporals.format(#temporals.createNow(),'yyyy-MM-dd HH:mm:ss')}"
							placeholder="">
						<div class="invalid-feedback" data-invalid-target="time"></div>
					</div>
					<div class="mb-3">
						<label class="form-label">访问密码</label> <input type="password" id="text"
							class="form-control">
						<div class="invalid-feedback" data-invalid-target="password"></div>
					</div>
					<div class="mb-3">
						<label class="form-check"> <input class="form-check-input" id="allowComment"
							type="checkbox" checked="checked"> <span
							class="form-check-label">允许评论</span>
						</label>
					</div>
					<div class="mb-3">
						<label class="form-check"> <input class="form-check-input" id="private"
							type="checkbox"> <span class="form-check-label">私人访问</span>
						</label>
					</div>
				</div>
			</div>
		</div>
	</div>
	<footer th:replace="console/fragment/footer"></footer>
	<script th:src="@{/static/console/js/upload.js}"></script>
	<script th:src="@{/static/console/js/fileSelector.js}"></script>
	<script th:src="@{/static/console/js/insertFile.js}"></script>
	<script th:src="@{/static/heather/js/heather_lazy.js}"></script>
	<script>
		LazyHeather.load(function(Heather) {
			Heather.lazyRes.mermaid_js = rootPath
					+ 'static/heather/js/mermaid.min.js';
			Heather.lazyRes.katex_css = rootPath
					+ 'static/heather/katex/katex.min.css';
			Heather.lazyRes.katex_js = rootPath
					+ 'static/heather/katex/katex.min.js';
			var heather = new Heather(document.getElementById('editor'), {
				editor : {
					lineNumbers : false
				}
			});

			var fs = new FileSelector(function(datas) {
				if (datas.length > 0) {
					insertFiles(datas, heather)
				}
			});

			if (!Heather.Util.mobile) {
				heather.on('fullscreenChange', function(fs) {
					heather.setSyncView(fs);
				})
			}

			var toolbar = heather.getToolbar();
			toolbar.addElement(Heather.Util.createBarIcon('fullscreen',function(elem){
				heather.setFullscreen(!heather.isFullscreen());
			}));
			toolbar.addElement(Heather.Util.createBarIcon('eye',function(elem){
				heather.setPreview(true);
			}));

			if(fileEnable){
				toolbar.addElement(Heather.Util.createBarIcon('file',function(elem){
					fs.open();
				}));
			}

			if (Heather.Util.mobile) {
				toolbar.addElement(Heather.Util.createBarIcon('cursor',function(elem){
					if (!heather.hasSelectionHelper()) {
						heather.openSelectionHelper();
					} else {
						heather.closeSelectionHelper();
					}
				}));
			}
			
			var back = document.getElementById('back-btn');
			back.addEventListener('click',function(){
				Swal.fire({
					  title: '确定要返回吗？',
					  text: "你会丢失没有保存的内容",
					  icon: 'warning',
					  showCancelButton: true,
					  confirmButtonColor: '#3085d6',
					  cancelButtonColor: '#d33'
					}).then((result) => {
					  if (result.value) {
					   	window.location.href = rootPath + 'console/moments?pageSize=10';
					  }
					})
			});
			
			var btn = document.getElementById('submit-btn');
			btn.addEventListener('click',function(){
				
				var data = {};
				data.content = heather.getValue();
				data.time = document.getElementById('time').value;
				data.password = document.getElementById('password').value;
				data.allowComment = document.getElementById('allowComment').checked;
				data.isPrivate = document.getElementById('private').checked;
				
				$.ajax({
					type : 'post',
					url : rootPath + 'console/moment/save',
		            contentType: 'application/json',
					data:JSON.stringify(data),
					success:function(data) {
						toast('保存成功');
						setTimeout(function(){
							window.location.href = rootPath + 'console/moments?pageSize=10'
						},500)
						clearFormError(document.body);
					},
					error:function(r){
						r.handled = true;
						clearFormError(document.body);
			        	var errors = r.responseJSON && r.responseJSON.errors;
			    		if(errors){
	    					if(errors[0].field){
			    				displayFormError(errors,document.body);
			    			} else {
			    				toastErrors(errors);
			    			}
			    		}
			        }
				  })
				
			})
		})
	</script>
</body>
</html>