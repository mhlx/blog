<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta http-equiv="Content-Language" content="en" />
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#4188c9">
<meta name="apple-mobile-web-app-status-bar-style"
	content="black-translucent" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">


<title>文件管理</title>
<link rel="stylesheet" th:href="@{/static/fontawesome/css/all.min.css}" />
<link th:href="@{/static/tabler/dist/assets/css/dashboard.css}"
	rel="stylesheet" />
<script th:src="@{/static/tabler/dist/assets/js/dashboard.js}"></script>
<link rel="stylesheet"
	th:href="@{/static/heather/codemirror/lib/codemirror.css}">
<link rel="stylesheet" th:href="@{/static/heather/css/markdown.css}">
<link rel="stylesheet" th:href="@{/static/heather/css/style.css}">
<link rel="stylesheet"
	th:href="@{/static/heather/highlight/styles/github.css}">
<link rel="stylesheet"
	th:href="@{/static/heather/codemirror/addon/dialog/dialog.css}">
<link rel="stylesheet"
	th:href="@{/static/heather/codemirror/addon/display/fullscreen.css}">
</head>

<body class="">
	<div class="page">
		<div class="flex-fill">
			<div th:replace="console/fragment/profile"></div>
			<div th:replace="console/fragment/headermenu('file')"></div>
			<div class="my-3 my-md-5">
				<div class="container">
					<textarea class="form-control" id="code">[[${file.content}]]</textarea>
				</div>
			</div>
		</div>
	</div>
	<footer th:replace="console/fragment/footer"></footer>
	<script th:src="@{/static/heather/highlight/highlight.pack.js}"></script>
	<!--CodeMirror-->
	<script th:src="@{/static/heather/codemirror/lib/codemirror.js}"></script>
	<script th:src="@{/static/heather/codemirror/addon/mode/overlay.js}"></script>
	<script th:src="@{/static/heather/codemirror/mode/xml/xml.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/mode/markdown/markdown.js}"></script>
	<script th:src="@{/static/heather/codemirror/mode/gfm/gfm.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/addon/selection/mark-selection.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/addon/selection/active-line.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/addon/search/searchcursor.js}"></script>
	<script th:src="@{/static/heather/codemirror/addon/search/search.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/addon/edit/continuelist.js}"></script>
	<script th:src="@{/static/heather/codemirror/addon/dialog/dialog.js}"></script>
	<script
		th:src="@{/static/heather/codemirror/addon/display/fullscreen.js}"></script>
	<script th:src="@{/static/heather/codemirror/addon/fold/foldcode.js}"></script>
	<script th:src="@{/static/heather/codemirror/addon/fold/foldgutter.js}"></script>
	<script th:src="@{/static/heather/js/markdown-it.min.js}"></script>
	<script th:src="@{/static/heather/js/markdown-it-task-lists.min.js}"></script>
	<script th:src="@{/static/heather/js/markdown-it-katex.min.js}"></script>
	<script th:src="@{/static/heather/js/markdownItAnchor.umd.js}"></script>
	<script th:src="@{/static/heather/js/morphdom-umd.min.js}"></script>
	<script th:src="@{/static/heather/js/heather.js}"></script>
	<script th:src="@{/static/console/js/upload.js}"></script>
	<script th:src="@{/static/console/js/fileSelector.js}"></script>
	<script th:src="@{/static/console/js/insertFile.js}"></script>
	<script>
		var path = '[[${file.path}]]'
		Heather.lazyRes.mermaid_js=rootPath+'static/heather/js/mermaid.min.js';
	    Heather.lazyRes.katex_css=rootPath+'static/heather/katex/katex.min.css';
	    Heather.lazyRes.katex_js=rootPath+'static/heather/katex/katex.min.js';
		var fs = new FileSelector(function(datas) {
			if (datas.length > 0) {
				insertFiles(datas, heather)
			}
		});
	    
		var heather = new Heather(document.getElementById('code'),{
			upload:{
				validate:function(file){
					return file.type.startsWith('image/');
				},
				url:function(){
					return rootPath + 'console/file/upload?dirPath='+fs.getPath()
				},
				uploadFinish:function(resp){
					resp = JSON.parse(resp);
					if(resp.errors){
						return null;
					}
					insertFiles([resp],heather);
				},
				fileNameGen:function(file){
					if(file.from === 'paste')
						return new Date().getTime() + '.'+file.name.split('.').pop();
					return file.name;
				}
			}
		})
		
		var toolbar = heather.getToolbar();
		
		toolbar.addElement(Heather.Util.createBarIcon('return',function(){
			Swal.fire({
			  title: '你确定要离开码？',
			  text: "没有保存的内容将会丢失",
			  type: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: '离开!',
			  cancelButtonText: '取消'
			}).then((result) => {
			  if (result.value) {
				  window.location.href = rootPath + 'console/files';
			  }
			});
		}));
		toolbar.addElement(Heather.Util.createBarIcon('fullscreen',function(elem){
			heather.setFullscreen(!heather.isFullscreen());
		}));
		if(fileEnable){
			toolbar.addElement(Heather.Util.createBarIcon('file',function(elem){
				fs.open();
			}));
		}
		
		function save(quietly){
			 $.ajax({
				type : 'post',
				url : rootPath + 'console/file/update?path='+path,
	            contentType: 'application/json',
				data:JSON.stringify({'content':heather.getValue()}),
				success:function(data) {
					if(quietly !== true)
						toast('保存成功');
				},
				error:function(e) {
					if(quietly === true) return ;
					var html = '';
					var errors = e.responseJSON.errors;
					for(const error of errors){
						html += '<p>'+error.message+'</p>';
					}
					toast(html,'error');
				}
			  })
		}
		toolbar.addElement(Heather.Util.createBarIcon('save',function(){
			save();
		}));
		
		if(Heather.Util.mobile){
			toolbar.addElement(Heather.Util.createBarIcon('cursor',function(elem){
				if (!heather.hasSelectionHelper()) {
					heather.openSelectionHelper();
				} else {
					heather.closeSelectionHelper();
				}
			}));
		} else {
			heather.on('fullscreenChange',function(fs){
				heather.setSyncView(fs);
			})
		}
		heather.setFullscreen(true);
		var timer;
		heather.on('editor.change',function(){
			clearTimeout(timer);
			timer = setTimeout(function(){
				save(true);
			},500)
		})

	</script>
</body>
</html>